{% extends "base.html" %}
{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header Section -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <div class="flex items-center gap-3 mb-2">
                <a href="/care-dashboard" class="inline-flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    Back to Dashboard
                </a>
            </div>
            <h1 class="text-3xl font-bold text-gray-900">Session Details</h1>
            <p class="text-gray-600">Session ID: <code class="bg-gray-100 px-2 py-1 rounded">{{ session_info[0] }}</code></p>
        </div>
        <div class="text-right">
            <div class="text-sm text-gray-500">{{ session_info[8].split(' ')[0] if session_info[8] else 'N/A' }}</div>
            <div class="text-lg font-semibold text-gray-700">{{ session_info[7] or 'Batch Analysis' }}</div>
        </div>
    </div>

    <!-- Session Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i data-lucide="users" class="w-5 h-5 text-blue-600"></i>
                </div>
                <span class="text-sm font-semibold text-gray-600">Total Patients</span>
            </div>
            <div class="text-3xl font-bold text-gray-900">{{ session_info[2] }}</div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                    <i data-lucide="bed" class="w-5 h-5 text-red-600"></i>
                </div>
                <span class="text-sm font-semibold text-gray-600">InCare</span>
            </div>
            <div class="text-3xl font-bold text-red-600">{{ session_info[3] }}</div>
            <div class="text-sm text-gray-500 mt-1">{{ "%.1f"|format((session_info[3] / session_info[2] * 100) if session_info[2] > 0 else 0) }}%</div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                    <i data-lucide="home" class="w-5 h-5 text-green-600"></i>
                </div>
                <span class="text-sm font-semibold text-gray-600">OutCare</span>
            </div>
            <div class="text-3xl font-bold text-green-600">{{ session_info[4] }}</div>
            <div class="text-sm text-gray-500 mt-1">{{ "%.1f"|format((session_info[4] / session_info[2] * 100) if session_info[2] > 0 else 0) }}%</div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                    <i data-lucide="stethoscope" class="w-5 h-5 text-yellow-600"></i>
                </div>
                <span class="text-sm font-semibold text-gray-600">Consult Doctor</span>
            </div>
            <div class="text-3xl font-bold text-yellow-600">{{ session_info[5] }}</div>
            <div class="text-sm text-gray-500 mt-1">{{ "%.1f"|format((session_info[5] / session_info[2] * 100) if session_info[2] > 0 else 0) }}%</div>
        </div>
    </div>

    <!-- Automation Rate -->
    <div class="bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200 rounded-xl p-6 mb-8">
        <div class="text-center">
            <div class="text-4xl font-bold text-emerald-600 mb-2">{{ session_info[6] }}%</div>
            <div class="text-lg font-semibold text-emerald-800 mb-2">Automation Rate</div>
            <div class="text-emerald-700">
                {{ session_info[3] + session_info[4] }} out of {{ session_info[2] }} patients were automatically classified
            </div>
        </div>
    </div>

    <!-- Classification Statistics -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-8 mb-8">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                <i data-lucide="bar-chart-3" class="w-5 h-5 text-purple-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-900">Classification Statistics</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {% for classification, stats in classification_stats.items() %}
            <div class="text-center p-6 {{ 'bg-red-50 border-red-200' if classification == 'InCare' else 'bg-green-50 border-green-200' if classification == 'OutCare' else 'bg-yellow-50 border-yellow-200' }} border rounded-xl">
                <div class="text-2xl font-bold {{ 'text-red-600' if classification == 'InCare' else 'text-green-600' if classification == 'OutCare' else 'text-yellow-600' }} mb-2">
                    {{ stats.count }}
                </div>
                <div class="font-semibold {{ 'text-red-800' if classification == 'InCare' else 'text-green-800' if classification == 'OutCare' else 'text-yellow-800' }} mb-2">
                    {{ classification }}
                </div>
                <div class="text-sm {{ 'text-red-600' if classification == 'InCare' else 'text-green-600' if classification == 'OutCare' else 'text-yellow-600' }}">
                    Avg Confidence: {{ "%.1f"|format(stats.avg_confidence) }}%
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Patient Details Table -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-8">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
                    <i data-lucide="table" class="w-5 h-5 text-indigo-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900">Patient Details</h2>
            </div>
            <div class="flex gap-2">
                <button onclick="exportToCSV()" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    Export CSV
                </button>
                <button onclick="window.print()" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
                    <i data-lucide="printer" class="w-4 h-4"></i>
                    Print Report
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full" id="patientsTable">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Patient #</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Classification</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Confidence</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Probability</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Age</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Sex</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Haematocrit</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Haemoglobins</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Erythrocyte</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Leucocyte</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Thrombocyte</th>
                    </tr>
                </thead>
                <tbody>
                    {% for patient in patients %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-4 font-medium">{{ patient[0] }}</td>
                        <td class="py-3 px-4">
                            {% if patient[1] == 'InCare' %}
                                <span class="inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">
                                    <i data-lucide="bed" class="w-3 h-3"></i>
                                    InCare
                                </span>
                            {% elif patient[1] == 'OutCare' %}
                                <span class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                                    <i data-lucide="home" class="w-3 h-3"></i>
                                    OutCare
                                </span>
                            {% else %}
                                <span class="inline-flex items-center gap-1 px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">
                                    <i data-lucide="stethoscope" class="w-3 h-3"></i>
                                    Consult Doctor
                                </span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex items-center gap-2">
                                <div class="w-16 bg-gray-200 rounded-full h-2">
                                    <div class="h-2 rounded-full {{ 'bg-green-500' if patient[2] >= 80 else 'bg-yellow-500' if patient[2] >= 60 else 'bg-red-500' }}" style="width: {{ patient[2] }}%"></div>
                                </div>
                                <span class="text-sm font-medium">{{ patient[2] }}%</span>
                            </div>
                        </td>
                        <td class="py-3 px-4">{{ patient[3] }}%</td>
                        <td class="py-3 px-4">{{ patient[12] }}</td>
                        <td class="py-3 px-4">
                            <span class="inline-flex items-center gap-1 px-2 py-1 {{ 'bg-blue-100 text-blue-800' if patient[13] == 'M' else 'bg-pink-100 text-pink-800' }} rounded-full text-sm">
                                {{ 'Male' if patient[13] == 'M' else 'Female' }}
                            </span>
                        </td>
                        <td class="py-3 px-4">{{ patient[4] }}</td>
                        <td class="py-3 px-4">{{ patient[5] }}</td>
                        <td class="py-3 px-4">{{ patient[6] }}</td>
                        <td class="py-3 px-4">{{ patient[7] }}</td>
                        <td class="py-3 px-4">{{ patient[8] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
    });

    function exportToCSV() {
        const table = document.getElementById('patientsTable');
        const rows = Array.from(table.querySelectorAll('tr'));
        
        const csvContent = rows.map(row => {
            const cells = Array.from(row.querySelectorAll('th, td'));
            return cells.map(cell => {
                // Clean up cell content (remove HTML tags)
                const text = cell.textContent.trim();
                return `"${text.replace(/"/g, '""')}"`;
            }).join(',');
        }).join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `session_{{ session_info[0] }}_details.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
{% endblock %}
